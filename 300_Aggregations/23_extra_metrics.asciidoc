

=== One Final Modification

논점을 바꿔서 새로운 주제로 가기 전에, 예제를 마지막으로 수정해 보자.((("aggregations", "basic example", "adding extra metrics")))((("metrics", "adding more to aggregation (example)"))) 제조사 별로 최소, 최대 가격을 계산하는 metric을 추가해 보자.

[source,js]
--------------------------------------------------
GET /cars/transactions/_search?search_type=count
{
   "aggs": {
      "colors": {
         "terms": {
            "field": "color"
         },
         "aggs": {
            "avg_price": { "avg": { "field": "price" }
            },
            "make" : {
                "terms" : {
                    "field" : "make"
                },
                "aggs" : { <1>
                    "min_price" : { "min": { "field": "price"} }, <2>
                    "max_price" : { "max": { "field": "price"} } <3>
                }
            }
         }
      }
   }
}
--------------------------------------------------
// SENSE: 300_Aggregations/20_basic_example.json

<1> 중첩된 또 다른 `aggs` 단계를 추가한다.
<2> `min` metric을 추가한다.
<3> `max` metric을 추가한다.

((("min and max metrics (aggregation example)"))) 다음과 같은 결과를 출력한다.

[source,js]
--------------------------------------------------
{
...
   "aggregations": {
      "colors": {
         "buckets": [
            {
               "key": "red",
               "doc_count": 4,
               "make": {
                  "buckets": [
                     {
                        "key": "honda",
                        "doc_count": 3,
                        "min_price": {
                           "value": 10000 <1>
                        },
                        "max_price": {
                           "value": 20000 <1>
                        }
                     },
                     {
                        "key": "bmw",
                        "doc_count": 1,
                        "min_price": {
                           "value": 80000
                        },
                        "max_price": {
                           "value": 80000
                        }
                     }
                  ]
               },
               "avg_price": {
                  "value": 32500
               }
            },
...
--------------------------------------------------
<1> 추가한 `min`과 `max` metric은 각 `make`의 아래에 나타난다.

두 bucket을 통해, query에서 다음과 같은 정보를 더 알 수 있다.

- 빨간 색상의 자동차 4대가 있다.
- 빨간 자동차의 평균가는 $32,500이다.
- 빨간 자동차 중 3대는 Honda, 하나는 BMW이다.
- 가장 저렴한 빨간 Honda 자동차는 10,000이다.
- 가장 비싼 빨간 Honda 자동차는 $20,000이다.
