
=== Adding a Metric to the Mix

이전 예제에서 각 bucket의 document 수를 알 수 있었다. 이것은 유용하다. ((("aggregations", "basic example", "adding a metric")))하지만 응용 프로그램에서는 document에 대해 더 복잡한 metric들을 요구한다.((("metrics", "adding to basic aggregation (example)"))) 각 bucket의 자동차 평균 가격이 어떻게 되는지에 대해 묻는 상황을 그 예로 들 수 있다.

이러한 정보를 얻기 위해 Elasticsearch는 특정 field에 대해 계산을 하기 위해 어떤 metric이 필요한지를 알아야만 한다. ((("buckets", "nesting metrics in"))) 바로 bucket 내부에 중첩하는 metric이다. metric은 어떤 bucket에 있는 document의 값에 기초하여 수학적 통계를 계산한다.

이전 자동차 예제에, ((("average metric")))`average` metric을 추가해 보자.

[source,js]
--------------------------------------------------
GET /cars/transactions/_search?search_type=count
{
   "aggs": {
      "colors": {
         "terms": {
            "field": "color"
         },
         "aggs": { <1>
            "avg_price": { <2>
               "avg": {
                  "field": "price" <3>
               }
            }
         }
      }
   }
}
--------------------------------------------------
// SENSE: 300_Aggregations/20_basic_example.json
<1> We add a new `aggs` level to hold the metric.
<2> We then give the metric a name: `avg_price`.
<3> And finally, we define it as an `avg` metric over the `price` field.
<1> metric을 가지기 위해, 새로운 `aggs` 단계를 추가한다.
<2> 그리고 metric의 이름을 `avg_price`라 한다.
<3> 마지막으로 `price` field에 대한 `avg` metric을 정의한다.

알다시피 이전 예제에 새로운 `aggs` 단계를 추가했다. 이 새로운 aggregation 단계는 `terms` bucket 내부에, `avg` metric을 중첩한 것이다. 결과적으로 각 색상에 대한 평균값을 얻을 수 있다.

`colors` 예제처럼, 이후에 값을 가져오기 위해 metric의 이름(`avg_price`)이 필요하다. 마지막으로 metric 자체(`avg`)와 평균을 계산하기 위한 field(`price`)를 지정한다.

[source,js]
--------------------------------------------------
{
...
   "aggregations": {
      "colors": {
         "buckets": [
            {
               "key": "red",
               "doc_count": 4,
               "avg_price": { <1>
                  "value": 32500
               }
            },
            {
               "key": "blue",
               "doc_count": 2,
               "avg_price": {
                  "value": 20000
               }
            },
            {
               "key": "green",
               "doc_count": 2,
               "avg_price": {
                  "value": 21000
               }
            }
         ]
      }
   }
...
}
--------------------------------------------------
<1> 응답에 새로운 avg_price 요소가 있다.

비록 응답은 최소한으로 변경했지만, 그것에서 얻은 데이터는 상당히 늘어났다. 이전에는 붉은 색상의 자동차는 4대가 있다고 알고 있었지만, 이제는 붉은 동자의 평균가격이 $32,500인 것을 알 수 있다. 이 결과를 보고서나 그래프에 바로 연결할 수 있다.
