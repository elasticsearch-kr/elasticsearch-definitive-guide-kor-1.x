
=== Buckets Inside Buckets

aggregation의 진정한 위력은 또 다른 중첩 방식을 적용해 보면 분명해진다.((("aggregations", "basic example", "buckets nested in other buckets")))((("buckets", "nested in other buckets"))) 이전의 예제에서, bucket 내부에 metric을 중첩하는 방법을 알 수 있었다. 그것만으로 이미 매우 강력하다.

하지만 진정한 흥미로운 분석은 다른 bucket 내부에 bucket을 중첩하는 것에 있다. 이제 각 색상의 자동차 제조업체 분포를 알아보자.

[source,js]
--------------------------------------------------
GET /cars/transactions/_search?search_type=count
{
   "aggs": {
      "colors": {
         "terms": {
            "field": "color"
         },
         "aggs": {
            "avg_price": { <1>
               "avg": {
                  "field": "price"
               }
            },
            "make": { <2>
                "terms": {
                    "field": "make" <3>
                }
            }
         }
      }
   }
}
--------------------------------------------------
// SENSE: 300_Aggregations/20_basic_example.json
<1> 이전 `avg_price` metric이 유지되어 있다.
<2> `make`라고 이름 붙인 또 다른 aggregation을 `colors` bucket에 추가하였다.
<3>  이 aggregation은 `terms` bucket이고, 각 자동차 제조업체에 대한 유일한 bucket을 생성할 것이다.

몇 가지 흥미로운 것이 여기에서 일어났다.((("metrics", "independent, on levels of an aggregation"))) 첫 번째는, 이전의 `avg_price` 통계가 완전히 그대로 남아 있다. aggregation 각 단계는 많은 metric과 bucket을 가질 수 있다. `avg_price` metric은 각 자동차 색상에 대한 평균 가격을 가져온다. 이것은 만들었던 다른 bucket과 metric들에 대해 독립적이다.

수집해야 하는 metric들이 많이 연관되어 있으면서도 완전히 별개라는 것은 응용 프로그램에 매우 중요하다. aggregation은 단 한번의 데이터 요청으로, 수집해야 하는 metric 모두를 수집할 수 있다.

주목해야 할 다른 중요한 점은, 추가한 aggregation `make`가 terms bucket(`colors` terms bucket에 중첩된)이라는 것이다. 이것은 데이터 집합에 있는 모든 유일한 조합에 위해 (`color`, `make`) tuple을 생성한다는 것을 의미한다.

응답을 살펴보자.


[source,js]
--------------------------------------------------
{
...
   "aggregations": {
      "colors": {
         "buckets": [
            {
               "key": "red",
               "doc_count": 4,
               "make": { <1>
                  "buckets": [
                     {
                        "key": "honda", <2>
                        "doc_count": 3
                     },
                     {
                        "key": "bmw",
                        "doc_count": 1
                     }
                  ]
               },
               "avg_price": {
                  "value": 32500 <3>
               }
            },

...
}
--------------------------------------------------
<1> 예상한 것처럼, 새로운 aggregation은 각 color bucket 아래에 중첩되어 있다.
<2> 색상 별로 자동차 제조사가 나누어져 있는 것을 알 수 있다.
<3> 마지막으로 이전의 `avg_price` 통계가 그대로 있는 것을 볼 수 있다.

이 응답에서 다음 사항을 알 수 있다.

- 빨간 색상의 자동차 4대가 있다.
- 빨간 자동차의 평균가는 $32,500이다.
- 빨간 자동차 중 3대는 Honda, 하나는 BMW이다.
